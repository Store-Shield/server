<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ í‚¤ì˜¤ìŠ¤í¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: #333;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .kiosk-screen {
            width: 100%;
            max-width: 800px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
        }
        
        .checkout-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 15px 35px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
        }
        
        .checkout-btn:hover {
            background-color: #388E3C;
            transform: scale(1.05);
        }
        
        .checkout-btn.disabled {
            background-color: #9E9E9E;
            cursor: not-allowed;
        }
        
        .payment-section {
            display: none;
            margin-top: 20px;
        }
        
        .loading-spinner {
            display: none;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .customer-info {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .cart-items {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .cart-items th, .cart-items td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .cart-items th {
            background-color: #f2f2f2;
        }
        
        .cart-items img {
            max-width: 50px;
            max-height: 50px;
            border-radius: 4px;
        }
        
        .cart-total {
            font-weight: bold;
            text-align: right;
            margin-top: 15px;
            font-size: 18px;
        }
        
        .confirm-payment-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .confirm-payment-btn:hover {
            background-color: #1976D2;
        }
        
        .payment-success {
            display: none;
            margin-top: 30px;
            color: #2E7D32;
            font-size: 24px;
            font-weight: bold;
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ë¬´ì¸ ìŠ¤ë§ˆíŠ¸ í‚¤ì˜¤ìŠ¤í¬</h1>
    </div>
    
    <div class="container">
        <div class="kiosk-screen">
            <h2>ê²°ì œë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>
            <p>ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ í´ë¦­í•˜ë©´, ìë™ìœ¼ë¡œ ì„ íƒí•˜ì‹  ìƒí’ˆì˜ ê²°ì œê°€ ì§„í–‰ë©ë‹ˆë‹¤.</p>
            
            <button id="checkout-btn" class="checkout-btn">ê²°ì œí•˜ê¸°</button>
            
            <div id="loading-spinner" class="loading-spinner"></div>
            
            <div id="customer-info" class="customer-info">
                <h3>ê³ ê° ì •ë³´</h3>
                <p id="customer-id">ê³ ê° ID: </p>
                
                <h4>ì¥ë°”êµ¬ë‹ˆ ë‚´ì—­</h4>
                <table class="cart-items">
                    <thead>
                        <tr>
                            <th>ìƒí’ˆ</th>
                            <th>ìƒí’ˆëª…</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>ê°€ê²©</th>
                            <th>ì†Œê³„</th>
                        </tr>
                    </thead>
                    <tbody id="cart-items-body">
                        <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                    </tbody>
                </table>
                
                <div class="cart-total">ì´ ê²°ì œê¸ˆì•¡: <span id="total-amount">0</span>ì›</div>
                
                <button id="confirm-payment-btn" class="confirm-payment-btn">ê²°ì œ í™•ì¸</button>
            </div>
            
            <div id="payment-success" class="payment-success">
                <p>ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                <p>ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
    
    <div class="connection-status" id="connection-status">ì—°ê²° ì¤‘...</div>
    
    <script>
        // Socket.IO ì—°ê²°
        const socket = io();
        const checkoutBtn = document.getElementById('checkout-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const customerInfo = document.getElementById('customer-info');
        const customerId = document.getElementById('customer-id');
        const cartItemsBody = document.getElementById('cart-items-body');
        const totalAmount = document.getElementById('total-amount');
        const confirmPaymentBtn = document.getElementById('confirm-payment-btn');
        const paymentSuccess = document.getElementById('payment-success');
        const connectionStatus = document.getElementById('connection-status');
        
        // ê²°ì œ ì¤‘ì¸ ê³ ê° ID
        let currentCustomerId = null;
        
        // ì—°ê²° ìƒíƒœ ê´€ë¦¬
        socket.on('connect', () => {
            connectionStatus.textContent = 'ì—°ê²°ë¨';
            connectionStatus.style.backgroundColor = 'rgba(76, 175, 80, 0.8)';
            setTimeout(() => {
                connectionStatus.style.opacity = '0';
            }, 3000);
        });
        
        socket.on('disconnect', () => {
            connectionStatus.textContent = 'ì—°ê²° ëŠê¹€';
            connectionStatus.style.backgroundColor = 'rgba(244, 67, 54, 0.8)';
            connectionStatus.style.opacity = '1';
        });
        
        // ê²°ì œí•˜ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        checkoutBtn.addEventListener('click', () => {
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            checkoutBtn.disabled = true;
            checkoutBtn.classList.add('disabled');
            
            // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
            loadingSpinner.style.display = 'block';
            
            // ì„œë²„ì— ê°€ì¥ ê°€ê¹Œìš´ ê³ ê° ìš”ì²­
            socket.emit('request_nearest_customer', { kioskId: 'kiosk1' });
        });
        
        // ê³ ê° ì •ë³´ ìˆ˜ì‹ 
        socket.on('customer_info', (data) => {
            // ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
            loadingSpinner.style.display = 'none';
            
            // ê³ ê° ì •ë³´ê°€ ìˆëŠ” ê²½ìš°
            if (data.success == 1) {
                currentCustomerId = data.customer.customer_id;
                
                // ê³ ê° ID í‘œì‹œ
                customerId.textContent = `ê³ ê° ID: ${data.customer.customer_id}`;
                
                // ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ìƒì„±
                cartItemsBody.innerHTML = '';
                let total = 0;
                
                // ê° ìƒí’ˆ ì¶”ê°€
                if (data.customer.cart_items && data.customer.cart_items.length > 0) {
                    data.customer.cart_items.forEach(item => {
                        const productImageHtml = item.product_image ? 
                            `<img src="data:image/jpeg;base64,${item.product_image}" alt="${item.product_name}">` : 
                            'ğŸ›’';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${productImageHtml}</td>
                            <td>${item.product_name}</td>
                            <td>${item.count}</td>
                            <td>${item.price.toLocaleString()}ì›</td>
                            <td>${item.subtotal.toLocaleString()}ì›</td>
                        `;
                        cartItemsBody.appendChild(row);
                        total += item.subtotal;
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="5" style="text-align: center;">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</td>
                    `;
                    cartItemsBody.appendChild(row);
                }
                
                // ì´ì•¡ ì—…ë°ì´íŠ¸
                totalAmount.textContent = total.toLocaleString();
                
                // ê³ ê° ì •ë³´ ì„¹ì…˜ í‘œì‹œ
                customerInfo.style.display = 'block';
            } else if (data.success == 0) {
                // ê³ ê°ì€ ì°¾ì•˜ì§€ë§Œ ê²°ì œí•  í’ˆëª©ì´ ì—†ëŠ” ê²½ìš°
                currentCustomerId = data.customer.customer_id;
                alert(`${currentCustomerId}ë‹˜ì€ ê²°ì œí•  í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.`);
                checkoutBtn.disabled = false;
                checkoutBtn.classList.remove('disabled');
            } else {
                // ê³ ê°ì„ ì°¾ì§€ ëª»í•œ ê²½ìš°
                alert('ê·¼ì²˜ì—ì„œ ê³ ê°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                checkoutBtn.disabled = false;
                checkoutBtn.classList.remove('disabled');
            }
        });
        
        // ê²°ì œ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        confirmPaymentBtn.addEventListener('click', () => {
            // ê²°ì œ í™•ì¸ ìš”ì²­
            socket.emit('confirm_payment', { customerId: currentCustomerId });
            
            // ê²°ì œ í™•ì¸ ë²„íŠ¼ ë¹„í™œì„±í™”
            confirmPaymentBtn.disabled = true;
            confirmPaymentBtn.classList.add('disabled');
        });
        
        // ê²°ì œ ì™„ë£Œ ì‘ë‹µ
        socket.on('payment_completed', (data) => {
            if (data.success) {
                // ê³ ê° ì •ë³´ ìˆ¨ê¸°ê¸°
                customerInfo.style.display = 'none';
                
                // ê²°ì œ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                paymentSuccess.style.display = 'block';
                
                // 3ì´ˆ í›„ ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ë¦¬ì…‹
                setTimeout(() => {
                    paymentSuccess.style.display = 'none';
                    checkoutBtn.disabled = false;
                    checkoutBtn.classList.remove('disabled');
                    confirmPaymentBtn.disabled = false;
                    confirmPaymentBtn.classList.remove('disabled');
                    currentCustomerId = null;
                }, 3000);
            } else {
                alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                confirmPaymentBtn.disabled = false;
                confirmPaymentBtn.classList.remove('disabled');
            }
        });
    </script>
</body>
</html>